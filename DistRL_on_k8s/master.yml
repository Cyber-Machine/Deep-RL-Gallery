apiVersion: v1
kind: Service
metadata:
  name: entrypoint
  namespace: default
spec:
  type: LoadBalancer
  ports:
  - port: 6006
    targetPort: 6006
    name: tensorboard
  - port: 8265
    targetPort: 8265
    name: ray-dashboard
  selector:
    app: master

---
apiVersion: v1
kind: Service
metadata:
  name: ray-headless-svc
  namespace: default
spec:
  clusterIP: None
  selector:
    app: master

---
apiVersion: v1
kind: Pod
metadata:
  name: master-pod
  namespace: default
  labels:
    app: master
spec:
  containers:
  - name: ray-master
    image: gcr.io/distrl-project/distrl
    command: ["/bin/sh", "-c"]
    args:
      - |
        ray start --head --port=6379 --dashboard-host "0.0.0.0"
        apt-get install -y vim
        while true
        do
          sleep 5
        done
        #python code/main.py --num_actors 10 --logdir log/tfboard --cluster
    ports:
      - containerPort: 6379
      - containerPort: 8265
    volumeMounts:
      - mountPath: "/log"
        name: log-volume
    resources:
      requests:
        cpu: "2"
        memory: "16Gi"
  - name: tensorboard
    image: tensorflow/tensorflow:2.3.0
    command: ["/bin/sh", "-c"]
    args:
      - |
        pip install tensorboard
        tensorboard --logdir /log/tfboard --bind_all
    ports:
      - containerPort: 6006
    volumeMounts:
      - mountPath: "/log"
        name: log-volume
    resources:
      requests:
        cpu: "1"
  volumes:
    - name: log-volume
      emptyDir: {}

---
apiVersion: v1
kind: Pod
metadata:
  name: debug
  namespace: default
  labels:
    app: debug
spec:
  containers:
    - name: debug
      image: centos:7
      command: ["sh", "-c"]
      args:
        - |
          yum install bind-utils -y
          while true
          do
            sleep 5
          done
